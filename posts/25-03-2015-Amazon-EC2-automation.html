<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="AWS, EC2, Automation, Boto, Python, ELB">
    <meta name="description" content="AWS Automation Tips Using Python and Boto Library">
    <meta name="author" content="Ankush Chadda">

    <title>Automating starting of EC2 machines</title>

    <!-- Bootstrap Core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/css/clean-blog.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top navbar-inverse">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/index.html">WebPad</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/index.html">Home</a>
                    </li>
                    <li>
                        <a href="http://ankushchadda.in">My HomeSite</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header class="intro-header" style="background-image: url('/img/automation.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Automating Starting of EC2 Instances</h1> 
                        <h2 class="subheading">Automation Tips Using Python and Boto Library</h2>
                        <span class="meta">Posted by <a href="http://ankushchadda.in">Ankush Chadda</a> on 25 March, 2015</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Post Content -->
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <p>Hey Everybody. This is my second post in this new blog. I am very excited to share this information with you all.</p>

                    <h2 class="section-heading">Scenario</h2>

                    <p>I had to setup an automated process where I can start an EC2 instance along with several other steps, which are as follows - </p>

                    <ul>
                        <li>Create a Security Group for EC2 instance. This was because I wanted the instance to serve requests coming only from the ELB.</li>
                        <li>Create a seperate Security Group for ELB. This was because I wanted a custom rule for each ELB.</li>
                        <li>Create an ELastic Load Balancer with required parameters.</li>
                        <li>Most importantly I had to create a autoscale group, to give me automatic scaling, in case things break down.</li>
                        <li>Lastly redirect the user to ELB once the setup is done.</li>
                    </ul>

                    <p>Later on I also had to automate the deletion of the instance. This meant taking down everything, EC2, ELB etc. I will describe this in the next post <a href="/posts/06-04-2015-Amazon-EC2-automation-part2.html">here</a></p>
                    <h2 class="section-heading">Making required base functions</h2>
                    <p>Boto has different classes for each type of AWS structure, like one HealthCheck, LaunchConfiguration etc. So it was better to make some configurable functions to create them. Very Useful later on.</p>

                    <pre class="prettyprint linenums">
CONN_REG = lambda region: boto.ec2.connect_to_region(
              region_name=region,
              aws_access_key_id=settings.AWS_ACCESS_KEY,
              aws_secret_access_key=settings.AWS_SECRET_KEY)

# Dont use ELBConnection because we want to connect to a specific region, and 
# by default ELBConnection takes us-east-2 , I think.
# CONN_ELB = ELBConnection(aws_access_key_id=settings.AWS_ACCESS_KEY, aws_secret_access_key=settings.AWS_SECRET_KEY)
CONN_ELB = lambda region: boto.ec2.elb.connect_to_region(
    aws_access_key_id=settings.AWS_ACCESS_KEY,
    aws_secret_access_key=settings.AWS_SECRET_KEY,
    region_name=region)

# Similar reason for not using AutoScaleConnection as for not using ELBConnection. See Above.
# CONN_AS = AutoScaleConnection(aws_access_key_id=settings.AWS_ACCESS_KEY, aws_secret_access_key=settings.AWS_SECRET_KEY)
CONN_AS = lambda region: boto.ec2.autoscale.connect_to_region(
    aws_access_key_id=settings.AWS_ACCESS_KEY,
    aws_secret_access_key=settings.AWS_SECRET_KEY,
    region_name=region)

hc = HealthCheck('healthCheck',
    interval=settings.ELASTIC_LOAD_BALANCER['interval'],
    target=settings.ELASTIC_LOAD_BALANCER['health_check_target'],
    timeout=settings.ELASTIC_LOAD_BALANCER['timeout'])

create_lc = lambda lc_name, sg: LaunchConfiguration(
    name=lc_name,
    image_id=settings.AUTOSCALING_AMI['id'],
    key_name=settings.AUTOSCALING_AMI['access_key'], security_groups=[sg], 
    instance_type=settings.AUTOSCALING_AMI['instance_type'],
    instance_monitoring=settings.AUTOSCALING_AMI['instance_monitoring'])


create_autoscalinggrp = lambda autosgname, lbname, zoneStrings, lc: AutoScalingGroup(
    group_name=autosgname,
    load_balancers=[lbname],
    availability_zones=zoneStrings,
    launch_config=lc,
    min_size=1,
    max_size=1)
                    </pre>
                    <h2 class="section-heading">Setting up EC2 instance with ELB and Autoscaling Group.</h2>

                    <p>Setting up of the instance is easy. We just need to have a specific format of doing things and things work. The following is how I did things - </p>

                    <ul>
                        <li>Decide which region you wish to have EC2 in.</li>
                        <li>Get Zones/Zone Names that will be used.</li>
                        <li>Create Both Security Groups</li>
                        <li>Create Load Balancer</li>
                        <li>Create AutoScale Group</li>
                    </ul>
                    <pre class="prettyprint linenums">
def setup_instance(*args):
    conn_reg = CONN_REG(region_name) # EC2 Connection   
    conn_as = CONN_AS(region_name) # AutoScaleConnection
    conn_elb = CONN_ELB(region_name) # ELB Connection                    

    all_zones = conn_reg.get_all_zones()
    zoneStrings = []
    for zone in all_zones:
        zoneStrings.append(zone.name)

    sg1 = conn_reg.create_security_group('SG-EC2', 'Securty group for EC2')
    sg = conn_reg.create_security_group('SG-ELB', 'Security group for ELB')
    #ELB can accept request from anywhere
    sg.authorize('tcp', 80, 80, '0.0.0.0/0')

    lb = conn_elb.create_load_balancer(
        loadbalancer_name,
        zoneStrings,
        settings.ELASTIC_LOAD_BALANCER, #Your own Settings
        security_groups=[sg.id])

    lb.configure_health_check(hc)

    # ElB will be available here.
    loadbalancer_dns = lb.dns_name

    # EC2 instance only gets access from ELB only
    conn_reg.authorize_security_group(
        group_name=sg1.name,
        src_security_group_name=sg.name, 
        src_security_group_owner_id=sg.owner_id)


    lc = create_lc(launch_configuration, sg1_name)
    conn_as.create_launch_configuration(lc)


    asg = create_autoscalinggrp(
        auto_scaling_group,
        loadbalancer_name,
        zoneStrings,
        launch_configuration)
    conn_as.create_auto_scaling_group(asg)
                    </pre>

                    <h2 class="section-heading">Automating the Instance startup</h2>
                    <p>We already have a method called setup_instance now. We just have to call it with approprate params now, which are - </p>
                    <ul>
                        <li>Region Name</li>
                        <li>Autoscaling group Name</li>
                        <li>Security Group Names for both EC2 or ELB</li>
                        <li>ELB Name</li>
                        <li>Launch Configuarion Name</li>
                    </ul>
                    <h2 class="section-heading">Trickiest Step</h2>
                    <p>In my scenaro, I had to redirect the user to ELB once it gets initialized. But AWS runs some checks before the instance becomes accesible. Since we are actually accessing EC2 via ELB, many a times, ELB was accessible but EC2 wasnt ready.</p>

                    <p>To overcome this, I had to make use of a very crude solution. A very basic hit and try method. </p>

                    <pre class="prettyprint linenums">
status_code = 100 #Fake status code to go into loop            

while status_code != 200:
    try:
        print "Still not ready, will try after 10 secs"
        time.sleep(10)
        status_code = requests.head(url).status_code
    except:
        pass    
                    </pre>

                    <p>And so, here it is, automated way to start EC2 instance with ElB and others.</p>

                    <p>Next, I will automate the way to take down the instance. You can check it <a href="/posts/06-04-2015-Amazon-EC2-automation-part2.html">here</a>.</p>
                </div>
            </div>
            <div id="disqus_thread"></div>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>

    </article>

    <hr>
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="http://twitter.com/iamkhush">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="http://facebook.com/iamkhush">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="http://github.com/iamkhush">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">Copyright &copy; Ankush Chadda 2015</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/js/clean-blog.min.js"></script>

    <!-- Code Prettifier -->
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?skin=sunburst"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-56883493-2', 'auto');
        ga('require', 'displayfeatures');
        ga('send', 'pageview');

        var disqus_shortname = 'ankushchaddablog';
        var disqus_url = 'http://blog.ankushchadda.in/posts/25-03-2015-Amazon-EC2-automation.html';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
</body>

</html>
